services:

  pg:
    build:
      context: ./pg
    container_name: pg
    ports:
      - "8081:8081"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - auth.env
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MAILERSEND_API_KEY=${MAILERSEND_API_KEY}
      - MAILERSEND_SENDER_EMAIL=${MAILERSEND_SENDER_EMAIL}
      - VAPI_API_KEY=${VAPI_API_KEY}
      - PHONE_NUMBER_ID=${PHONE_NUMBER_ID}
      # LiveKit (optional - for provider=livekit calls)
      - LIVEKIT_URL=${LIVEKIT_URL}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - SIP_OUTBOUND_TRUNK_ID=${SIP_OUTBOUND_TRUNK_ID}

  # LiveKit survey agent worker (optional - only needed for provider=livekit)
  livekit-agent:
    build:
      context: ./pg
    container_name: livekit-agent
    entrypoint: ["python", "livekit_agent.py", "dev"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - LIVEKIT_URL=${LIVEKIT_URL}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - SIP_OUTBOUND_TRUNK_ID=${SIP_OUTBOUND_TRUNK_ID}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - BACKEND_URL=http://pg:8081/pg
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    depends_on:
      - pg
    profiles:
      - livekit

  dashboard:
    build:
      context: ./dashboard
      args:
        - VITE_SERVER_URL=http://localhost:8081/pg
        - VITE_RECIPIENT_URL=http://localhost:3000
    container_name: dashboard
    ports:
      - "8080:8080"
    depends_on:
      - pg

  recipient:
    build:
      context: ./recipient
      args:
        - NEXT_PUBLIC_API_BASE_URL=http://localhost:8081
    container_name: recipient
    ports:
      - "3000:3000"
    environment:
      - DEEPGRAM_API_TOKEN=${DEEPGRAM_API_TOKEN}
    depends_on:
      - pg
